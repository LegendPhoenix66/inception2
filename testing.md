# Inception — End‑to‑End Testing Guide (for VM testers)

This document walks you through everything needed to test this repository from scratch inside a Linux virtual machine: cloning, setting up, bringing the stack up, and verifying that all mandatory requirements of the subject are met. It also includes persistence checks and common troubleshooting.

Assumptions
- You are inside a Linux VM (Debian/Ubuntu recommended).
- You have sudo privileges in the VM and internet access.
- You will follow all steps inside the VM terminal.

If you get stuck, see the Troubleshooting section at the end.

---

## 1) Quick start (TL;DR)

- Clone and enter the repo:
  - git clone <your-fork-or-repo-url>
  - cd inception
- Run setup:
  - bash setup.sh
  - If prompted for sudo, enter your password.
  - If the script says you were added to the docker group, you may need to run: newgrp docker
- Start the stack:
  - make up
- Open the site in the VM’s browser:
  - Run: make url (prints the full URL). Copy and paste it into your browser inside the VM.
  - Or open: https://<your-domain> (example: https://lhopp.42.fr)
  - Accept the self‑signed certificate in your browser.
- Admin credentials are in secrets/credentials.txt (generated by setup). Do not commit this file.

---

## 2) Full setup steps

2.1. Clone the repository
- Install git if needed: sudo apt-get update && sudo apt-get install -y git
- Clone:
  - git clone <your-fork-or-repo-url>
  - cd inception

2.2. Run the setup
- bash setup.sh
  - What it does:
    - Installs Docker Engine, docker compose plugin (v2) or a v1 fallback, and make (Debian/Ubuntu).
    - Creates or updates srcs/.env with:
      - DOMAIN_NAME (e.g., yourlogin.42.fr)
      - MYSQL_DATABASE and MYSQL_USER
      - DATA_PATH (bind-mount base path; defaults to /home/your-user/data)
    - Generates or strengthens secrets in secrets/:
      - db_root_password.txt
      - db_password.txt
      - credentials.txt (WordPress admin/user credentials). Admin username is enforced not to contain “admin/administrator”.
    - Ensures data directories exist at $DATA_PATH/wordpress and $DATA_PATH/mariadb
    - Adds an /etc/hosts entry mapping DOMAIN_NAME to 127.0.0.1 inside the VM for local browsing.
  - If you were added to the docker group: either log out/in or run newgrp docker in the same shell to refresh group membership. Note: our Makefile transparently falls back to sudo for Docker if needed, so make up will still work.

2.3. Start the stack
- make up
  - The Makefile will:
    - Auto-detect docker compose (v2) or docker-compose (v1).
    - Use sudo automatically if your user cannot access the Docker socket yet.
    - Ensure $DATA_PATH subdirectories exist before bringing containers up.

2.4. Optional: Force rebuild
- If you changed code or configs and want a clean rebuild:
  - make build  (rebuild images)
  - or make re  (full cleanup + rebuild + up)

---

## 3) Accessing the site in the VM

- Determine the domain from .env:
  - `echo "Domain:" $(awk -F= '/^DOMAIN_NAME=/{print $2}' srcs/.env)`
- Confirm the VM resolves the domain to 127.0.0.1:
  - `getent hosts $(awk -F= '/^DOMAIN_NAME=/{print $2}' srcs/.env)`
    - Expected: 127.0.0.1 <your-domain>
- Open the site (inside the VM browser):
  - Run: make url (prints the full URL). Copy it into your browser inside the VM.
  - Or open: https://<your-domain> (example: https://lhopp.42.fr)
  - Accept the self‑signed certificate warning (normal for local dev).

Admin credentials
- Stored in secrets/credentials.txt (created/updated by setup.sh). Example:
  - cat secrets/credentials.txt
  - Use WP_ADMIN_USER and WP_ADMIN_PASSWORD to log in at https://<domain>/wp-admin

---

## 4) Verification checklist (maps to subject requirements)

Use these checks to ensure the mandatory part is PERFECT.

4.1. Dockerfiles and images
- Each service is built from our own Dockerfile (no ready‑made images pulled):
  - grep -n "build:" srcs/docker-compose.yml
    - Expected: build directives for nginx, wordpress, mariadb
  - grep -n "image:" srcs/docker-compose.yml
    - Expected: images named nginx, wordpress, mariadb (matching service names)
- Base OS is Alpine or Debian (penultimate stable):
  - grep -n "^FROM" srcs/requirements/*/Dockerfile
    - Expected: FROM alpine:3.19 (or Debian) — no latest tags
- No latest tag usage in our own FROM lines:
  - grep -R "FROM .*:latest" -n srcs/requirements || echo "OK: no latest tags"

4.2. No secrets in Dockerfiles; env + secrets used
- Confirm no plaintext passwords in Dockerfiles:
  - grep -R "PASSWORD" -n srcs/requirements || echo "No password strings in Dockerfiles"
- Confirm .env and Docker secrets are used:
  - cat srcs/.env  (contains DOMAIN_NAME, MYSQL_DATABASE, MYSQL_USER, DATA_PATH)
  - In docker-compose.yml, verify secrets are mounted:
    - grep -n "secrets:" -n srcs/docker-compose.yml
    - Expected secrets: db_root_password, db_password, credentials

4.3. Network and isolation
- Only the Nginx container publishes ports, and only 443:
  - grep -n "ports:" -n srcs/docker-compose.yml
  - Expected: "443:443" under nginx only
- No host networking or legacy links used:
  - grep -n "network: host\|--link\|links:" -n srcs/docker-compose.yml || echo "OK: none used"
- A custom network is defined and used:
  - grep -n "networks:" -n srcs/docker-compose.yml
  - docker network ls | grep inception

4.4. Nginx TLS configuration
- TLSv1.2 and TLSv1.3 only and port 443 only:
  - grep -n "ssl_protocols" srcs/requirements/nginx/conf/default.conf
  - grep -n "listen 443" srcs/requirements/nginx/conf/default.conf
- Self‑signed certs are generated at container start with proper SANs (domain, localhost, 127.0.0.1). OCSP stapling is disabled for self‑signed certs.
- From the VM, this should succeed (you will see certificate details):
  - `curl -vk https://$(awk -F= '/^DOMAIN_NAME=/{print $2}' srcs/.env)/`

4.5. WordPress container (php-fpm only; no Nginx inside)
- Check the container runs php-fpm in foreground:
  - docker ps | grep wordpress
  - docker logs wordpress | tail -n 50
- Confirm Nginx forwards PHP to WordPress FPM (fastcgi_pass wordpress:9000 in default.conf):
  - grep -n "fastcgi_pass wordpress:9000" srcs/requirements/nginx/conf/default.conf

4.6. MariaDB container
- Check it is running and initialized:
  - docker ps | grep mariadb
  - docker logs mariadb | tail -n 50
- Check the required DB and user exist (run inside the container):
  - docker exec -it mariadb sh -lc 'mysql -uroot -p"$(cat /run/secrets/db_root_password)" -e "SHOW DATABASES;"'
  - docker exec -it mariadb sh -lc 'mysql -uroot -p"$(cat /run/secrets/db_root_password)" -e "SELECT User,Host FROM mysql.user;"'
  - Expected:
    - Your ${MYSQL_DATABASE} is listed (default: wordpress)
    - A user ${MYSQL_USER}@% exists (default: wpuser)

4.7. WordPress initial state and users
- Log in at https://<domain>/wp-admin using credentials from secrets/credentials.txt
- Confirm there are two users: the admin and the additional user
  - Via UI: Users → All Users
  - Or via WP‑CLI inside the container:
    - docker exec -it wordpress sh -lc 'wp user list --allow-root'
- Verify the admin username does NOT contain "admin" or "administrator"
  - Our setup enforces this; still confirm via Users list or:
    - docker exec -it wordpress sh -lc 'wp user get $(grep WP_ADMIN_USER secrets/credentials.txt | cut -d= -f2) --field=user_login --allow-root'
    - Expected: user_login matches secrets/credentials.txt and does not contain admin/administrator

4.8. Volumes and data persistence
- Host bind-mount base path (from srcs/.env):
  - `echo $(awk -F= '/^DATA_PATH=/{print $2}' srcs/.env)`
  - Expected directories exist: $DATA_PATH/wordpress and $DATA_PATH/mariadb
- Persistence test:
  1) In WordPress, create a new Post (e.g., title: "Persistence Test") and publish it. Optionally upload a media file.
  2) Restart the stack:
     - make down
     - make up
  3) Refresh the site; the post and media should still be present.

4.9. Restart policies and resilience
- Compose specifies restart: unless-stopped for services. Verify:
  - grep -n "restart: unless-stopped" srcs/docker-compose.yml
- Kill and observe restart:
  - docker kill nginx
  - sleep 3 && docker ps | grep nginx  (container should be back up due to restart policy)

4.10. Domain name policy
- Subject requires domain login.42.fr mapped to your VM’s local IP.
  - Our setup writes /etc/hosts mapping inside the VM so you can access https://<yourlogin>.42.fr locally.
  - Confirm:
    - `grep $(awk -F= '/^DOMAIN_NAME=/{print $2}' srcs/.env) /etc/hosts`
    - Expected: 127.0.0.1 <yourlogin>.42.fr
- If your login is different, update srcs/.env then re-run bash setup.sh (it will maintain directories and secrets):
  - sed -i "s/^DOMAIN_NAME=.*/DOMAIN_NAME=<yourlogin>.42.fr/" srcs/.env
  - bash setup.sh

---

## 5) Operational commands

- Start: make up
- Stop: make down
- Rebuild images: make build
- Clean containers/networks/unused images: make clean
- Full reset (also removes host data directory): make fclean
- Logs (follow): make logs
- Status: make status
- Enter a container shell: make exec SERVICE=nginx (or wordpress/mariadb)

---

## 6) Troubleshooting

Docker permission denied to /var/run/docker.sock
- Symptom: permission denied connecting to Docker daemon
- Fix: Our Makefile auto‑prefixes with sudo when needed. You can also log out/in or run newgrp docker after setup.

"docker: 'compose' is not a docker command"
- Fix: setup.sh installs compose v2 (or a v1 fallback) automatically. Re-run bash setup.sh. The Makefile also auto‑detects v2/v1.

TLS/Firefox PR_END_OF_FILE_ERROR
- Fixes are included:
  - Self‑signed certificate includes SANs (domain, localhost, 127.0.0.1)
  - OCSP stapling disabled for self‑signed certs
- Ensure you access by domain (https://<domain>) not by raw IP. If you changed DOMAIN_NAME, re-run bash setup.sh, then make build && make up so Nginx regenerates its cert/config.

"failed to populate volume: ... no such file or directory"
- Cause: host directories missing at $DATA_PATH
- Fix: make up now ensures directories exist. You can also run bash setup.sh to prepare them.

WordPress credentials not working / want to reset
- The credentials are generated in secrets/credentials.txt and used on first install.
- If WordPress is already initialized, changing secrets won’t reset the site automatically. To reset entirely:
  - make fclean  (removes the data directory and volumes)
  - bash setup.sh
  - make up

No access by domain from the host machine
- This guide only guarantees in‑VM access. For host access, add a hosts entry on your host OS mapping <domain> to the VM IP.

---

## 7) What to present during defense (mapping to subject)

- Show srcs/docker-compose.yml with three services (nginx, wordpress, mariadb), each built from your own Dockerfile, with restart policies, two bind‑mount volumes, and a custom bridge network.
- Show that only Nginx publishes port 443 and that TLSv1.2/1.3 is enforced.
- Show that WordPress has two users and that the admin username does not contain "admin"/"administrator".
- Show that volumes persist by creating content, restarting, and observing it remains.
- Show no passwords are present in Dockerfiles and that Docker secrets and environment variables are used.
- Show the domain <login>.42.fr resolves inside the VM and is used to access the site over HTTPS.

---

## 8) Clean up after testing

- Stop services: make down
- Remove containers, networks, dangling images: make clean
- Remove all persisted data (irreversible!): make fclean

---

Appendix A: Useful one‑liners
- Show domain, db name, user, data path:
  - awk -F= '/^(DOMAIN_NAME|MYSQL_DATABASE|MYSQL_USER|DATA_PATH)=/{print $0}' srcs/.env
- Show running containers for this project:
  - make status
- Tail logs for Nginx:
  - docker logs -f nginx
- List WordPress users via WP‑CLI:
  - docker exec -it wordpress sh -lc 'wp user list --allow-root'
- Open a MySQL shell as root:
  - docker exec -it mariadb sh -lc 'mysql -uroot -p"$(cat /run/secrets/db_root_password)"'

Notes
- Do not commit files under secrets/.
- If you change DOMAIN_NAME in srcs/.env, re-run bash setup.sh and then make build && make up to regenerate certificates and apply the new server_name.
